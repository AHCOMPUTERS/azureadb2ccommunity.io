<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Azure AD B2C</title>
<meta name="description" content="Want to become a pro in B2C? We are here to help ">


  <meta name="author" content="Azure AD B2C">


<meta property="og:type" content="website">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Azure AD B2C">
<meta property="og:title" content="Azure AD B2C">
<meta property="og:url" content="http://localhost:4000/previous_wiki_backup/LocalAndSocialAccount-Sign-In-and-Sign-Up-policy/">


  <meta property="og:description" content="Want to become a pro in B2C? We are here to help ">



  <meta property="og:image" content="http://localhost:4000/assets/images/site-logo.png">



  <meta name="twitter:site" content="@mmistakes">
  <meta name="twitter:title" content="Azure AD B2C">
  <meta name="twitter:description" content="Want to become a pro in B2C? We are here to help ">
  <meta name="twitter:url" content="http://localhost:4000/previous_wiki_backup/LocalAndSocialAccount-Sign-In-and-Sign-Up-policy/">

  
    <meta name="twitter:card" content="summary">
    
      <meta name="twitter:image" content="http://localhost:4000/assets/images/site-logo.png">
    
  

  







  

  


<link rel="canonical" href="http://localhost:4000/previous_wiki_backup/LocalAndSocialAccount-Sign-In-and-Sign-Up-policy/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Michael Rose",
      "url": "http://localhost:4000/",
      "sameAs": ["https://twitter.com/mmistakes","https://www.facebook.com/michaelrose"]
    
  }
</script>


  <meta name="google-site-verification" content="UQj93ERU9zgECodaaXgVpkjrFn9UrDMEzVamacSoQ8Y" />





<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Azure AD B2C Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--default">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/"><img src="/assets/images/b2c-logo.png" alt=""></a>
        
        <a class="site-title" href="/">
          Azure AD B2C
          <span class="site-subtitle">Community</span>
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/training/identity-protocols-custom-policies/">Training</a>
            </li><li class="masthead__menu-item">
              <a href="/docs/custom-policy-concepts/">IEF Wiki</a>
            </li><li class="masthead__menu-item">
              <a href="/about/">About</a>
            </li></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      <p>The following article will make use of the learnings from previous articles in order to understand how a Local and Social Account sign in and sign up is achieved with the starter pack files.</p>

<p>The Local Accounts starter pack can be found <a href="https://github.com/Azure-Samples/active-directory-b2c-custom-policy-starterpack/tree/master/SocialAndLocalAccounts">here</a>. The files of interest are TrustFrameworkBase.xml and TrustFrameworkExtensions.xml.</p>

<p>You will find the user journey and its orchestration steps in the TrustFrameworkBase.xml file, with the Id “SignUpOrSignIn”. Each Orchestration step and its referenced technical profile will be explained in detail in the following series.</p>

<p>For a user to be able to Sign in and Sign Up, the following User Experience must be translated into logical steps with a custom policy.</p>

<h3 id="logical-steps">Logical Steps</h3>
<p>Handling Sign In for a Local Account:</p>
<ol>
  <li>Display a page where the user can enter their email and password.</li>
  <li>On the sign in page, display a link to sign up.</li>
  <li>If the user submits their credentials (signs in), we must validate the credentials.</li>
  <li>Issue an id token.</li>
</ol>

<p>Handling Sign In/Up for a SocialAccount:</p>
<ol>
  <li>Display a page where the user can select to use their Facebook account.</li>
  <li>When the user clicks to “Login with Facebook”, the user will be redirected to Facebook.</li>
  <li>When the user returns from Facebook, read the information Facebook provided.</li>
  <li>Lookup the account in the Azure AD B2C directory to determine if this user has already signed in with Facebook previously.</li>
  <li>Display a page where the user can modify the data, returned from Facebook about their profile if this is their first time logging in with Facebook.</li>
  <li>Write the account information to Azure AD B2C if the account was not already present in the directory.</li>
  <li>Issue an id token.</li>
</ol>

<p>Handling Sign Up for a Local Account:</p>
<ol>
  <li>Display a page that allows users to enter their email, password and name.</li>
  <li>Verify their email with a Timed One Time Passcode sent to their email address.</li>
  <li>When the user completes a sign up, we must create their account.</li>
  <li>Prevent a user to sign up with an existing email address.</li>
  <li>Issue an id token.</li>
</ol>

<h3 id="translating-this-into-custom-policies">Translating this into custom policies:</h3>
<p>Handling Sign In for a Local Account:</p>
<ol>
  <li>This requires a Self-Asserted technical profile. It must present output claims to obtain the email and password claims.</li>
  <li>Use the combined sign in and sign up content definition which provides this for us.</li>
  <li>Run a Validation technical profile to validate the credentials.</li>
  <li>Read any additional information from the directory user object.</li>
  <li>Call a technical profile to issue a token.</li>
</ol>

<p>Handling Sign In/Up for a SocialAccount:</p>

<ol>
  <li>Display a page where the user can select to use their Facebook account.</li>
  <li>When the user clicks to “Login with Facebook”, the user will be redirected to Facebook.</li>
  <li>Lookup the account in the Azure AD B2C directory to determine if this user has already signed in with Facebook previously.</li>
  <li>Display a page where the user can modify the data, returned from Facebook about their profile if this is their first time logging in with Facebook.</li>
  <li>Write the account information to Azure AD B2C if the account was not already present in the directory.</li>
  <li>
    <p>Issue an id token.</p>
  </li>
  <li>Using the combined sign in and sign up page, we must instruct Azure AD B2C that there is a new claims provider - Facebook. This will present a button on the page to “Login with Facebook”</li>
  <li>An OAuth2 technical profile must be configured to be able to redirect the user to Facebook.</li>
  <li>Use an Azure Active Directory technical profile to read the directory based off of the user identifier returned from Facebook. Usually the subject claim.</li>
  <li>Use a Self-Asserted technical profile which presents the first name and last name retrieved from Facebook in editable text boxes.</li>
  <li>Use an Azure Active Directory technical profile to write the account data into the Azure AD B2C directory.</li>
  <li>Call a technical profile to issue a token.</li>
</ol>

<p>Handling Sign Up for a Local Account:</p>
<ol>
  <li>This requires a Self-Asserted technical profile. It must present output claims to obtain the email, password and name claims.</li>
  <li>Make use of a special claim which enforced email verification.</li>
  <li>Use a Validation technical profile to write the account to the directory. This Validation technical profile will be of type Azure Active Directory.</li>
  <li>As part of writing the account configure the technical profile to throw an error if the account exists.</li>
  <li>Read any additional information from the directory user object.</li>
  <li>Call a technical profile to issue a token.</li>
</ol>

<h2 id="understand-the-socialandlocalaccounts-starterpack-implementation">Understand the SocialAndLocalAccounts starterpack implementation</h2>
<p>The SocialAndLocalAccounts starter pack comes pre built with a lot of functionality for the various scenarios presented within the starter pack - Sign In, Sign Up, Password Reset and Profile Edit.
When reading the user journey for a social and local account sign up or sign in, a fraction of the foundational elements contained within the files are being used. The following will unpick the elements and describe in detail the operation of a single journey.</p>

<h3 id="handling-sign-in-for-a-local-account-and-social-account">Handling Sign In for a Local Account and Social Account:</h3>
<p><strong>Orchestration Step 1</strong>: Provide functionality for a user to Sign in or Sign Up. This is achieved using a Self-Asserted technical profile and connected validation technical profile.</p>

<p>The XML required to generate this step is:</p>
<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;OrchestrationStep</span> <span class="na">Order=</span><span class="s">"1"</span> <span class="na">Type=</span><span class="s">"CombinedSignInAndSignUp"</span> <span class="na">ContentDefinitionReferenceId=</span><span class="s">"api.signuporsignin"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;ClaimsProviderSelections&gt;</span>
    <span class="nt">&lt;ClaimsProviderSelection</span> <span class="na">TargetClaimsExchangeId=</span><span class="s">"FacebookExchange"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;ClaimsProviderSelection</span> <span class="na">ValidationClaimsExchangeId=</span><span class="s">"LocalAccountSigninEmailExchange"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/ClaimsProviderSelections&gt;</span>
  <span class="nt">&lt;ClaimsExchanges&gt;</span>
    <span class="nt">&lt;ClaimsExchange</span> <span class="na">Id=</span><span class="s">"LocalAccountSigninEmailExchange"</span> <span class="na">TechnicalProfileReferenceId=</span><span class="s">"SelfAsserted-LocalAccountSignin-Email"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/ClaimsExchanges&gt;</span>
<span class="nt">&lt;/OrchestrationStep&gt;</span>
</code></pre></div></div>

<p>The combined sign in and sign up page is treated specially by Azure AD B2C, since it presents a sign up link that can take the user to the sign up step.
This is achieved with the following two lines:</p>
<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;OrchestrationStep</span> <span class="na">Order=</span><span class="s">"1"</span> <span class="na">Type=</span><span class="s">"CombinedSignInAndSignUp"</span> <span class="na">ContentDefinitionReferenceId=</span><span class="s">"api.signuporsignin"</span><span class="nt">&gt;</span>
</code></pre></div></div>

<p>Since Azure AD B2C understands that this is a Sign In page, you must specify the <code class="language-plaintext highlighter-rouge">ClaimsProviderSelections</code> element with at least one reference to a <code class="language-plaintext highlighter-rouge">ClaimsProviderSelection</code>. This <code class="language-plaintext highlighter-rouge">ClaimsProviderSelection</code> maps to the <code class="language-plaintext highlighter-rouge">ClaimsExchange</code>. In this case, there are two <code class="language-plaintext highlighter-rouge">ClaimsProviderSelection</code> elements, such that Azure AD B2C understands that there is a Local Account and Facebook option to present on the page. The Local Account <code class="language-plaintext highlighter-rouge">ClaimsProviderSelection</code> maps to the <code class="language-plaintext highlighter-rouge">LocalAccountSigninEmailExchange</code> claims exchange, which will call the <code class="language-plaintext highlighter-rouge">SelfAsserted-LocalAccountSignin-Email</code> technical profile.</p>

<p>The <code class="language-plaintext highlighter-rouge">SelfAsserted-LocalAccountSignin-Email</code> technical profile defines the actual page functionality, allowing the user to sign in:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;TechnicalProfile</span> <span class="na">Id=</span><span class="s">"SelfAsserted-LocalAccountSignin-Email"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;DisplayName&gt;</span>Local Account Signin<span class="nt">&lt;/DisplayName&gt;</span>
  <span class="nt">&lt;Protocol</span> <span class="na">Name=</span><span class="s">"Proprietary"</span> <span class="na">Handler=</span><span class="s">"Web.TPEngine.Providers.SelfAssertedAttributeProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;Metadata&gt;</span>
    <span class="nt">&lt;Item</span> <span class="na">Key=</span><span class="s">"SignUpTarget"</span><span class="nt">&gt;</span>SignUpWithLogonEmailExchange<span class="nt">&lt;/Item&gt;</span>
    <span class="nt">&lt;Item</span> <span class="na">Key=</span><span class="s">"setting.operatingMode"</span><span class="nt">&gt;</span>Email<span class="nt">&lt;/Item&gt;</span>
    <span class="nt">&lt;Item</span> <span class="na">Key=</span><span class="s">"ContentDefinitionReferenceId"</span><span class="nt">&gt;</span>api.selfasserted<span class="nt">&lt;/Item&gt;</span>
  <span class="nt">&lt;/Metadata&gt;</span>
  <span class="nt">&lt;IncludeInSso&gt;</span>false<span class="nt">&lt;/IncludeInSso&gt;</span>
  <span class="nt">&lt;InputClaims&gt;</span>
    <span class="nt">&lt;InputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"signInName"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/InputClaims&gt;</span>
  <span class="nt">&lt;OutputClaims&gt;</span>
    <span class="nt">&lt;OutputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"signInName"</span> <span class="na">Required=</span><span class="s">"true"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;OutputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"password"</span> <span class="na">Required=</span><span class="s">"true"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;OutputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"objectId"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;OutputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"authenticationSource"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/OutputClaims&gt;</span>
  <span class="nt">&lt;ValidationTechnicalProfiles&gt;</span>
    <span class="nt">&lt;ValidationTechnicalProfile</span> <span class="na">ReferenceId=</span><span class="s">"login-NonInteractive"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/ValidationTechnicalProfiles&gt;</span>
  <span class="nt">&lt;UseTechnicalProfileForSessionManagement</span> <span class="na">ReferenceId=</span><span class="s">"SM-AAD"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/TechnicalProfile&gt;</span>
</code></pre></div></div>

<table>
  <thead>
    <tr>
      <th>Element name</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>TechnicalProfile Id</td>
      <td>Identifier for this technical profile. It is used to find the technical profile that is referenced elsewhere, in this case from the Orchestration step.</td>
    </tr>
    <tr>
      <td>DisplayName</td>
      <td>Friendly name which can describe the function of this technical profile.</td>
    </tr>
    <tr>
      <td>Protocol</td>
      <td>The Azure AD B2C technical profile type. In this case, it is Self-Asserted, such that a page is rendered for the user to provide their inputs.</td>
    </tr>
    <tr>
      <td>Metadata</td>
      <td>For a Self Asserted Combined Sign in and Sign up profile, we provide a SignUpTarget which points to the Sign Up ClaimsExchange Id in a subsequent orchestrations step.</td>
    </tr>
    <tr>
      <td>InputClaims</td>
      <td>Enables the ability to pre-populate the signInName claim</td>
    </tr>
    <tr>
      <td>OutputClaims</td>
      <td>We require the user to provide their email and password, hence referenced as output claims. There are some claims here, such as objectId, that are not presented on the page since the validation technical profile satisfies this output claim.</td>
    </tr>
    <tr>
      <td>ValidationTechnicalProfiles</td>
      <td>The technical profile to launch to validate the date the user provided, in this case to validate their credentials.</td>
    </tr>
    <tr>
      <td>UseTechnicalProfileForSessionManagement</td>
      <td>TO DO</td>
    </tr>
  </tbody>
</table>

<p>To see all the configuration options for a Self-Asserted technical profile, find more <a href="https://docs.microsoft.com/en-us/azure/active-directory-b2c/self-asserted-technical-profile">here</a>.</p>

<p>By calling this technical profile we now satisfy the initial logical step for sign in. When the user submits the page, the Validation technical profile will run, called <code class="language-plaintext highlighter-rouge">login-NonInteractive</code>.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nt">&lt;ValidationTechnicalProfile</span> <span class="na">ReferenceId=</span><span class="s">"login-NonInteractive"</span> <span class="nt">/&gt;</span>
</code></pre></div></div>

<p>This is a technical profile which makes an OpenID request using the <a href="https://tools.ietf.org/html/rfc6749#section-4.3">Resource Owner Password Credential</a> grant flow to validate the users credentials at the Azure AD authorization server. Essentially this is an API based logon which the Azure AD B2C server will complete against the Azure AD authorization server.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;TechnicalProfile</span> <span class="na">Id=</span><span class="s">"login-NonInteractive"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;DisplayName&gt;</span>Local Account SignIn<span class="nt">&lt;/DisplayName&gt;</span>
  <span class="nt">&lt;Protocol</span> <span class="na">Name=</span><span class="s">"OpenIdConnect"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;Metadata&gt;</span>
    <span class="nt">&lt;Item</span> <span class="na">Key=</span><span class="s">"UserMessageIfClaimsPrincipalDoesNotExist"</span><span class="nt">&gt;</span>We can't seem to find your account<span class="nt">&lt;/Item&gt;</span>
    <span class="nt">&lt;Item</span> <span class="na">Key=</span><span class="s">"UserMessageIfInvalidPassword"</span><span class="nt">&gt;</span>Your password is incorrect<span class="nt">&lt;/Item&gt;</span>
    <span class="nt">&lt;Item</span> <span class="na">Key=</span><span class="s">"UserMessageIfOldPasswordUsed"</span><span class="nt">&gt;</span>Looks like you used an old password<span class="nt">&lt;/Item&gt;</span>

    <span class="nt">&lt;Item</span> <span class="na">Key=</span><span class="s">"ProviderName"</span><span class="nt">&gt;</span>https://sts.windows.net/<span class="nt">&lt;/Item&gt;</span>
    <span class="nt">&lt;Item</span> <span class="na">Key=</span><span class="s">"METADATA"</span><span class="nt">&gt;</span>https://login.microsoftonline.com/{tenant}/.well-known/openid-configuration<span class="nt">&lt;/Item&gt;</span>
    <span class="nt">&lt;Item</span> <span class="na">Key=</span><span class="s">"authorization_endpoint"</span><span class="nt">&gt;</span>https://login.microsoftonline.com/{tenant}/oauth2/token<span class="nt">&lt;/Item&gt;</span>
    <span class="nt">&lt;Item</span> <span class="na">Key=</span><span class="s">"response_types"</span><span class="nt">&gt;</span>id_token<span class="nt">&lt;/Item&gt;</span>
    <span class="nt">&lt;Item</span> <span class="na">Key=</span><span class="s">"response_mode"</span><span class="nt">&gt;</span>query<span class="nt">&lt;/Item&gt;</span>
    <span class="nt">&lt;Item</span> <span class="na">Key=</span><span class="s">"scope"</span><span class="nt">&gt;</span>email openid<span class="nt">&lt;/Item&gt;</span>

    <span class="c">&lt;!-- Policy Engine Clients --&gt;</span>
    <span class="nt">&lt;Item</span> <span class="na">Key=</span><span class="s">"UsePolicyInRedirectUri"</span><span class="nt">&gt;</span>false<span class="nt">&lt;/Item&gt;</span>
    <span class="nt">&lt;Item</span> <span class="na">Key=</span><span class="s">"HttpBinding"</span><span class="nt">&gt;</span>POST<span class="nt">&lt;/Item&gt;</span>
  <span class="nt">&lt;/Metadata&gt;</span>
  <span class="nt">&lt;InputClaims&gt;</span>
    <span class="nt">&lt;InputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"signInName"</span> <span class="na">PartnerClaimType=</span><span class="s">"username"</span> <span class="na">Required=</span><span class="s">"true"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;InputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"password"</span> <span class="na">Required=</span><span class="s">"true"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;InputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"grant_type"</span> <span class="na">DefaultValue=</span><span class="s">"password"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;InputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"scope"</span> <span class="na">DefaultValue=</span><span class="s">"openid"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;InputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"nca"</span> <span class="na">PartnerClaimType=</span><span class="s">"nca"</span> <span class="na">DefaultValue=</span><span class="s">"1"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/InputClaims&gt;</span>
  <span class="nt">&lt;OutputClaims&gt;</span>
    <span class="nt">&lt;OutputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"objectId"</span> <span class="na">PartnerClaimType=</span><span class="s">"oid"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;OutputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"tenantId"</span> <span class="na">PartnerClaimType=</span><span class="s">"tid"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;OutputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"givenName"</span> <span class="na">PartnerClaimType=</span><span class="s">"given_name"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;OutputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"surName"</span> <span class="na">PartnerClaimType=</span><span class="s">"family_name"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;OutputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"displayName"</span> <span class="na">PartnerClaimType=</span><span class="s">"name"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;OutputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"userPrincipalName"</span> <span class="na">PartnerClaimType=</span><span class="s">"upn"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;OutputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"authenticationSource"</span> <span class="na">DefaultValue=</span><span class="s">"localAccountAuthentication"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/OutputClaims&gt;</span>
<span class="nt">&lt;/TechnicalProfile&gt;</span>
</code></pre></div></div>

<table>
  <thead>
    <tr>
      <th>Element name</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>TechnicalProfile Id</td>
      <td>Identifier for this technical profile. It is used to find the technical profile that is referenced elsewhere.</td>
    </tr>
    <tr>
      <td>DisplayName</td>
      <td>Friendly name which can describe the function of this technical profile.</td>
    </tr>
    <tr>
      <td>Protocol</td>
      <td>The Azure AD B2C technical profile type. In this case, it is OpenId, such that Azure AD B2C understands to make an OpenId request.</td>
    </tr>
    <tr>
      <td>Metadata</td>
      <td>Various configuration options with which to make a valid OpenId request. This also includes various error handling responses, such as incorrect password.</td>
    </tr>
    <tr>
      <td>InputClaims</td>
      <td>Passes the username and password into the POST body of the OpenId request.</td>
    </tr>
    <tr>
      <td>OutputClaims</td>
      <td>Maps the JWT issued by the authorization server into Azure AD B2C’s claim bag. Here we obtain the objectId and authenticationSource, hence it is not shown on the Self-Asserted page explained previously.</td>
    </tr>
  </tbody>
</table>

<p>To see all the configuration options for an OpenId Connect technical profile, find more <a href="https://docs.microsoft.com/en-us/azure/active-directory-b2c/openid-connect-technical-profile">here</a>.</p>

<p>At this point we have now rendered a sign in page to the user, has the option to Sign In with Facebook, or provide their email and password after which they are verified against the Directory.</p>

<p><strong>Orchestration Step 2</strong>: Since Orchestration Step 1 provided a <code class="language-plaintext highlighter-rouge">ClaimsProviderSelection</code> for Facebook, this is satisfied in step 2 as part of a <code class="language-plaintext highlighter-rouge">ClaimsExchange</code>. Here the <code class="language-plaintext highlighter-rouge">ClaimsProviderSelection</code> for <code class="language-plaintext highlighter-rouge">FacebookExchange</code> is satisfied by referencing the <code class="language-plaintext highlighter-rouge">Facebook-OAUTH</code> technical profile, which provides the necessary means to redirect the user to Facebook for sign in.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- Check if the user has selected to sign in using one of the social providers --&gt;</span>
<span class="nt">&lt;OrchestrationStep</span> <span class="na">Order=</span><span class="s">"2"</span> <span class="na">Type=</span><span class="s">"ClaimsExchange"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;Preconditions&gt;</span>
    <span class="nt">&lt;Precondition</span> <span class="na">Type=</span><span class="s">"ClaimsExist"</span> <span class="na">ExecuteActionsIf=</span><span class="s">"true"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;Value&gt;</span>objectId<span class="nt">&lt;/Value&gt;</span>
      <span class="nt">&lt;Action&gt;</span>SkipThisOrchestrationStep<span class="nt">&lt;/Action&gt;</span>
    <span class="nt">&lt;/Precondition&gt;</span>
  <span class="nt">&lt;/Preconditions&gt;</span>
  <span class="nt">&lt;ClaimsExchanges&gt;</span>
    <span class="nt">&lt;ClaimsExchange</span> <span class="na">Id=</span><span class="s">"FacebookExchange"</span> <span class="na">TechnicalProfileReferenceId=</span><span class="s">"Facebook-OAUTH"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;ClaimsExchange</span> <span class="na">Id=</span><span class="s">"SignUpWithLogonEmailExchange"</span> <span class="na">TechnicalProfileReferenceId=</span><span class="s">"LocalAccountSignUpWithLogonEmail"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/ClaimsExchanges&gt;</span>
<span class="nt">&lt;/OrchestrationStep&gt;</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">Facebook-OAUTH</code> technical profile is as follows in the base file:</p>
<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;TechnicalProfile</span> <span class="na">Id=</span><span class="s">"Facebook-OAUTH"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;DisplayName&gt;</span>Facebook<span class="nt">&lt;/DisplayName&gt;</span>
  <span class="nt">&lt;Protocol</span> <span class="na">Name=</span><span class="s">"OAuth2"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;Metadata&gt;</span>
    <span class="nt">&lt;Item</span> <span class="na">Key=</span><span class="s">"ProviderName"</span><span class="nt">&gt;</span>facebook<span class="nt">&lt;/Item&gt;</span>
    <span class="nt">&lt;Item</span> <span class="na">Key=</span><span class="s">"authorization_endpoint"</span><span class="nt">&gt;</span>https://www.facebook.com/dialog/oauth<span class="nt">&lt;/Item&gt;</span>
    <span class="nt">&lt;Item</span> <span class="na">Key=</span><span class="s">"AccessTokenEndpoint"</span><span class="nt">&gt;</span>https://graph.facebook.com/oauth/access_token<span class="nt">&lt;/Item&gt;</span>
    <span class="nt">&lt;Item</span> <span class="na">Key=</span><span class="s">"HttpBinding"</span><span class="nt">&gt;</span>GET<span class="nt">&lt;/Item&gt;</span>
    <span class="nt">&lt;Item</span> <span class="na">Key=</span><span class="s">"UsePolicyInRedirectUri"</span><span class="nt">&gt;</span>0<span class="nt">&lt;/Item&gt;</span>
    <span class="nt">&lt;Item</span> <span class="na">Key=</span><span class="s">"AccessTokenResponseFormat"</span><span class="nt">&gt;</span>json<span class="nt">&lt;/Item&gt;</span>
  <span class="nt">&lt;/Metadata&gt;</span>
  <span class="nt">&lt;CryptographicKeys&gt;</span>
    <span class="nt">&lt;Key</span> <span class="na">Id=</span><span class="s">"client_secret"</span> <span class="na">StorageReferenceId=</span><span class="s">"B2C_1A_FacebookSecret"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/CryptographicKeys&gt;</span>
  <span class="nt">&lt;InputClaims</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;OutputClaims&gt;</span>
    <span class="nt">&lt;OutputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"issuerUserId"</span> <span class="na">PartnerClaimType=</span><span class="s">"id"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;OutputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"givenName"</span> <span class="na">PartnerClaimType=</span><span class="s">"first_name"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;OutputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"surname"</span> <span class="na">PartnerClaimType=</span><span class="s">"last_name"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;OutputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"displayName"</span> <span class="na">PartnerClaimType=</span><span class="s">"name"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;OutputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"email"</span> <span class="na">PartnerClaimType=</span><span class="s">"email"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;OutputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"identityProvider"</span> <span class="na">DefaultValue=</span><span class="s">"facebook.com"</span> <span class="na">AlwaysUseDefaultValue=</span><span class="s">"true"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;OutputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"authenticationSource"</span> <span class="na">DefaultValue=</span><span class="s">"socialIdpAuthentication"</span> <span class="na">AlwaysUseDefaultValue=</span><span class="s">"true"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/OutputClaims&gt;</span>
  <span class="nt">&lt;OutputClaimsTransformations&gt;</span>
    <span class="nt">&lt;OutputClaimsTransformation</span> <span class="na">ReferenceId=</span><span class="s">"CreateRandomUPNUserName"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;OutputClaimsTransformation</span> <span class="na">ReferenceId=</span><span class="s">"CreateUserPrincipalName"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;OutputClaimsTransformation</span> <span class="na">ReferenceId=</span><span class="s">"CreateAlternativeSecurityId"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/OutputClaimsTransformations&gt;</span>
  <span class="nt">&lt;UseTechnicalProfileForSessionManagement</span> <span class="na">ReferenceId=</span><span class="s">"SM-SocialLogin"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/TechnicalProfile&gt;</span>
</code></pre></div></div>
<p>|Element name  |Description  |
|———|———|
|TechnicalProfile Id | Identifier for this technical profile. It is used to find the technical profile that is referenced elsewhere.|
|DisplayName|Friendly name which can describe the function of this technical profile.|
|Protocol|The Azure AD B2C technical profile type. In this case, it is OAuth2, such that Azure AD B2C understands to make an OAuth2 request.|
|Metadata|Various configuration options with which to make a valid OAuth2 request. Some of these options are specific to Facebook’s requirements.|
|InputClaims|There is nothing to send to Facebook, only an OAuth2 request.|
|OutputClaims| Maps the JWT issued by the Facebook authorization server into Azure AD B2C’s claim bag. Some claims have default values assigned, hence are not asked from the user.|
|OutputClaimsTransformations| Various claims transformations that are called to manipulate the data returned from the token sent back by Facebook before being added into the Azure AD B2C claims bag.|</p>

<p>And the <code class="language-plaintext highlighter-rouge">Facebook-OAUTH</code> technical profile has an augmentation in the Extensions file as follows to complete the setup. For administrators integrating Facebook login, these are the only parameters to modify, therefore they are added as augmentations into the Extension file, while the Base technical profile will be static for all environments.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;TechnicalProfile</span> <span class="na">Id=</span><span class="s">"Facebook-OAUTH"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;Metadata&gt;</span>
    <span class="nt">&lt;Item</span> <span class="na">Key=</span><span class="s">"client_id"</span><span class="nt">&gt;</span>facebook_clientid<span class="nt">&lt;/Item&gt;</span>
    <span class="nt">&lt;Item</span> <span class="na">Key=</span><span class="s">"scope"</span><span class="nt">&gt;</span>email public_profile<span class="nt">&lt;/Item&gt;</span>
    <span class="nt">&lt;Item</span> <span class="na">Key=</span><span class="s">"ClaimsEndpoint"</span><span class="nt">&gt;</span>https://graph.facebook.com/me?fields=id,first_name,last_name,name,email<span class="nt">&lt;/Item&gt;</span>
  <span class="nt">&lt;/Metadata&gt;</span>
<span class="nt">&lt;/TechnicalProfile&gt;</span>
</code></pre></div></div>

<table>
  <thead>
    <tr>
      <th>Element name</th>
      <th>Description</th>
      <th> </th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td> </td>
      <td>TechnicalProfile Id</td>
      <td>Identifier for this technical profile. It is used to find the technical profile that is referenced elsewhere or in this case has the same name as in the Base file to augment it.</td>
    </tr>
    <tr>
      <td> </td>
      <td>Metadata</td>
      <td>Additional configuration options with which to make a valid OAuth2 request. These are specific to ones own federation with Facebook.</td>
    </tr>
  </tbody>
</table>

<p>Here is the breakdown of each claims transformation that is run after the Facebook authentication succeeds and the token is returned back to Azure AD B2C. This applies to all external Identity Provider integration.</p>

<p>These are run such that pre-requisites for creating the account in Azure AD B2C and also for reading the account on subsequent sign in’s.</p>

<p><strong>CreateRandomUPNUserName</strong> - This is required to generate a <strong>prefix</strong> for the userPrincipalName which will be stored on the user account when created.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;ClaimsTransformation</span> <span class="na">Id=</span><span class="s">"CreateRandomUPNUserName"</span> <span class="na">TransformationMethod=</span><span class="s">"CreateRandomString"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;InputParameters&gt;</span>
    <span class="nt">&lt;InputParameter</span> <span class="na">Id=</span><span class="s">"randomGeneratorType"</span> <span class="na">DataType=</span><span class="s">"string"</span> <span class="na">Value=</span><span class="s">"GUID"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/InputParameters&gt;</span>
  <span class="nt">&lt;OutputClaims&gt;</span>
    <span class="nt">&lt;OutputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"upnUserName"</span> <span class="na">TransformationClaimType=</span><span class="s">"outputClaim"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/OutputClaims&gt;</span>
<span class="nt">&lt;/ClaimsTransformation&gt;</span>
</code></pre></div></div>
<p>This claims transform generates a random string which is in the format of a GUID and issues it into the claim called <code class="language-plaintext highlighter-rouge">upnUserName</code>.</p>

<p><strong>CreateUserPrincipalName</strong> - This creates the final userPrincipalName.</p>
<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;ClaimsTransformation</span> <span class="na">Id=</span><span class="s">"CreateUserPrincipalName"</span> <span class="na">TransformationMethod=</span><span class="s">"FormatStringClaim"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;InputClaims&gt;</span>
    <span class="nt">&lt;InputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"upnUserName"</span> <span class="na">TransformationClaimType=</span><span class="s">"inputClaim"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/InputClaims&gt;</span>
  <span class="nt">&lt;InputParameters&gt;</span>
    <span class="nt">&lt;InputParameter</span> <span class="na">Id=</span><span class="s">"stringFormat"</span> <span class="na">DataType=</span><span class="s">"string"</span> <span class="na">Value=</span><span class="s">"cpim_{0}@{RelyingPartyTenantId}"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/InputParameters&gt;</span>
  <span class="nt">&lt;OutputClaims&gt;</span>
    <span class="nt">&lt;OutputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"userPrincipalName"</span> <span class="na">TransformationClaimType=</span><span class="s">"outputClaim"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/OutputClaims&gt;</span>
<span class="nt">&lt;/ClaimsTransformation&gt;</span>
</code></pre></div></div>
<p>This claims transform uses the <code class="language-plaintext highlighter-rouge">FormatStringClaim</code> method to create a string value using claims in the Azure AD B2C claim bag. The claim given to this transform is <code class="language-plaintext highlighter-rouge">upnUserName</code>, which is available from the output of the previous claims transform. Here the transform inserts the first input claim into <code class="language-plaintext highlighter-rouge">{0}</code> and Azure AD B2C knows the value of <code class="language-plaintext highlighter-rouge">{RelyingPartyTenantId}</code> already. Then end result is a fully formed userPrincipalName, which is output in the <code class="language-plaintext highlighter-rouge">userPrincipalName</code> claim: <code class="language-plaintext highlighter-rouge">00000000-0000-0000-0000-000000000000@something.onmicrosoft.com</code>.</p>

<p><strong>CreateAlternativeSecurityId</strong> - This creates a user identifier similar to an objectId which will be used to map the subject claim (sub) from the Facebook token to the Azure AD B2C user on subsequent logons. The generated identifier is output into the claim called <code class="language-plaintext highlighter-rouge">alternativeSecurityId</code>.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;ClaimsTransformation</span> <span class="na">Id=</span><span class="s">"CreateAlternativeSecurityId"</span> <span class="na">TransformationMethod=</span><span class="s">"CreateAlternativeSecurityId"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;InputClaims&gt;</span>
    <span class="nt">&lt;InputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"issuerUserId"</span> <span class="na">TransformationClaimType=</span><span class="s">"key"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;InputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"identityProvider"</span> <span class="na">TransformationClaimType=</span><span class="s">"identityProvider"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/InputClaims&gt;</span>
  <span class="nt">&lt;OutputClaims&gt;</span>
    <span class="nt">&lt;OutputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"alternativeSecurityId"</span> <span class="na">TransformationClaimType=</span><span class="s">"alternativeSecurityId"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/OutputClaims&gt;</span>
<span class="nt">&lt;/ClaimsTransformation&gt;</span>
</code></pre></div></div>

<p>After this, the Facebook login is complete, and the claims from the token received from Facebook have been transformed into useful entities for Azure AD B2C to use.</p>

<p><strong>Orchestration Step 3</strong>: Read any additional data from the social account user object.</p>

<p>We need to determine if the social account has already been registered previously with this Azure AD B2C directory, or if this is their first logon via Facebook. Also we maybe storing additional data the user provided or other data on the user object which allows your application/service to function correctly.</p>

<p>Therefore, we will attempt to read the user object for any desired attributes to add into the Azure AD B2C claims bag. This technical profile is configured such that it does not throw an error if an account is not found.</p>

<p>The following Orchestration step calls a technical profile called <code class="language-plaintext highlighter-rouge">AAD-UserReadUsingAlternativeSecurityId-NoError</code> which provides this functionality.
The ClaimsExchange Id is a unique name for this claims exchange that you can set.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- For social IDP authentication, attempt to find the user account in the directory. --&gt;</span>
<span class="nt">&lt;OrchestrationStep</span> <span class="na">Order=</span><span class="s">"3"</span> <span class="na">Type=</span><span class="s">"ClaimsExchange"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;Preconditions&gt;</span>
    <span class="nt">&lt;Precondition</span> <span class="na">Type=</span><span class="s">"ClaimEquals"</span> <span class="na">ExecuteActionsIf=</span><span class="s">"true"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;Value&gt;</span>authenticationSource<span class="nt">&lt;/Value&gt;</span>
      <span class="nt">&lt;Value&gt;</span>localAccountAuthentication<span class="nt">&lt;/Value&gt;</span>
      <span class="nt">&lt;Action&gt;</span>SkipThisOrchestrationStep<span class="nt">&lt;/Action&gt;</span>
    <span class="nt">&lt;/Precondition&gt;</span>
  <span class="nt">&lt;/Preconditions&gt;</span>
  <span class="nt">&lt;ClaimsExchanges&gt;</span>
    <span class="nt">&lt;ClaimsExchange</span> <span class="na">Id=</span><span class="s">"AADUserReadUsingAlternativeSecurityId"</span> <span class="na">TechnicalProfileReferenceId=</span><span class="s">"AAD-UserReadUsingAlternativeSecurityId-NoError"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/ClaimsExchanges&gt;</span>
<span class="nt">&lt;/OrchestrationStep&gt;</span>
</code></pre></div></div>
<p>A <strong>precondition</strong> is used such that this step is only run if a Social Account authentication had been completed. This is achieved by checking whether the value of <code class="language-plaintext highlighter-rouge">authenticationSource</code> claim is equal to <code class="language-plaintext highlighter-rouge">localAccountAuthentication</code>. If <code class="language-plaintext highlighter-rouge">authenticationSource</code> does contain the value <code class="language-plaintext highlighter-rouge">localAccountAuthentication</code>, then this step is skipped, otherwise it is executed.</p>

<p>The referenced technical profile appears as follows:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;TechnicalProfile</span> <span class="na">Id=</span><span class="s">"AAD-UserReadUsingAlternativeSecurityId-NoError"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;Metadata&gt;</span>
    <span class="nt">&lt;Item</span> <span class="na">Key=</span><span class="s">"RaiseErrorIfClaimsPrincipalDoesNotExist"</span><span class="nt">&gt;</span>false<span class="nt">&lt;/Item&gt;</span>
  <span class="nt">&lt;/Metadata&gt;</span>
  <span class="nt">&lt;IncludeTechnicalProfile</span> <span class="na">ReferenceId=</span><span class="s">"AAD-UserReadUsingAlternativeSecurityId"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/TechnicalProfile&gt;</span>
</code></pre></div></div>

<p>This technical profile is taking the <code class="language-plaintext highlighter-rouge">AAD-UserReadUsingAlternativeSecurityId</code> technical profile and applying a modification to it. The modification here is only to prevent an error being raised if the user is not found in the directory. This will provide an indication if this is the first logon via Facebook for this user, or a subsequent logon.</p>

<p>The following implements the <code class="language-plaintext highlighter-rouge">AAD-UserReadUsingAlternativeSecurityId</code> technical profile.</p>
<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;TechnicalProfile</span> <span class="na">Id=</span><span class="s">"AAD-UserReadUsingAlternativeSecurityId"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;Metadata&gt;</span>
    <span class="nt">&lt;Item</span> <span class="na">Key=</span><span class="s">"Operation"</span><span class="nt">&gt;</span>Read<span class="nt">&lt;/Item&gt;</span>
    <span class="nt">&lt;Item</span> <span class="na">Key=</span><span class="s">"RaiseErrorIfClaimsPrincipalDoesNotExist"</span><span class="nt">&gt;</span>true<span class="nt">&lt;/Item&gt;</span>
    <span class="nt">&lt;Item</span> <span class="na">Key=</span><span class="s">"UserMessageIfClaimsPrincipalDoesNotExist"</span><span class="nt">&gt;</span>User does not exist. Please sign up before you can sign in.<span class="nt">&lt;/Item&gt;</span>
  <span class="nt">&lt;/Metadata&gt;</span>
  <span class="nt">&lt;InputClaims&gt;</span>
    <span class="nt">&lt;InputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"AlternativeSecurityId"</span> <span class="na">PartnerClaimType=</span><span class="s">"alternativeSecurityId"</span> <span class="na">Required=</span><span class="s">"true"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/InputClaims&gt;</span>
  <span class="nt">&lt;OutputClaims&gt;</span>
    <span class="c">&lt;!-- Required claims --&gt;</span>
    <span class="nt">&lt;OutputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"objectId"</span> <span class="nt">/&gt;</span>
    <span class="c">&lt;!-- Optional claims --&gt;</span>
    <span class="nt">&lt;OutputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"userPrincipalName"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;OutputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"displayName"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;OutputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"otherMails"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;OutputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"givenName"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;OutputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"surname"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/OutputClaims&gt;</span>
  <span class="nt">&lt;IncludeTechnicalProfile</span> <span class="na">ReferenceId=</span><span class="s">"AAD-Common"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/TechnicalProfile&gt;</span>
</code></pre></div></div>
<p>This technical profile does not state a protocol, therefore is automatically of type <code class="language-plaintext highlighter-rouge">Azure Active Directory</code>, which provides the ability to read or write to the directory structure.</p>

<table>
  <thead>
    <tr>
      <th>Element name</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>TechnicalProfile Id</td>
      <td>Identifier for this technical profile. It is used to find the technical profile that is referenced elsewhere.</td>
    </tr>
    <tr>
      <td>Metadata</td>
      <td>This is configured to read the directory. And to throw an error if the user is not found. This has been overridden by <code class="language-plaintext highlighter-rouge">AAD-UserReadUsingAlternativeSecurityId-NoError</code>.</td>
    </tr>
    <tr>
      <td>InputClaims</td>
      <td>This is attempting to find a user account with the <code class="language-plaintext highlighter-rouge">alternativeSecurityId</code> generated in the claims transform after the Facebook sign in completed.</td>
    </tr>
    <tr>
      <td>OutputClaims</td>
      <td>We are asking to read these claims from the directory. The Azure AD B2C claims referenced here have the same name as the attribute name in the directory.</td>
    </tr>
    <tr>
      <td>IncludeTechnicalProfile</td>
      <td>AAD-Common is included to provide the foundational functionality to read or write to the directory.</td>
    </tr>
  </tbody>
</table>

<p>At this point the Azure AD B2C claims bag will now contain an objectId for the Social Account user who signed in, or not if this user is signing in for the first time.</p>

<p><strong>Orchestration Step 4</strong>: A Self-Asserted technical profile is used to display a page to the user to see the imported data from Facebook, and have the ability to modify it. This is only presented to a user who has logged in for the first time with Facebook.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;OrchestrationStep</span> <span class="na">Order=</span><span class="s">"4"</span> <span class="na">Type=</span><span class="s">"ClaimsExchange"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;Preconditions&gt;</span>
    <span class="nt">&lt;Precondition</span> <span class="na">Type=</span><span class="s">"ClaimsExist"</span> <span class="na">ExecuteActionsIf=</span><span class="s">"true"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;Value&gt;</span>objectId<span class="nt">&lt;/Value&gt;</span>
      <span class="nt">&lt;Action&gt;</span>SkipThisOrchestrationStep<span class="nt">&lt;/Action&gt;</span>
    <span class="nt">&lt;/Precondition&gt;</span>
  <span class="nt">&lt;/Preconditions&gt;</span>
  <span class="nt">&lt;ClaimsExchanges&gt;</span>
    <span class="nt">&lt;ClaimsExchange</span> <span class="na">Id=</span><span class="s">"SelfAsserted-Social"</span> <span class="na">TechnicalProfileReferenceId=</span><span class="s">"SelfAsserted-Social"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/ClaimsExchanges&gt;</span>
<span class="nt">&lt;/OrchestrationStep&gt;</span>
</code></pre></div></div>
<p>This contains a <strong>precondition</strong> which skips this step if an objectId was found, since the presence of an objectId would mean the user has already signed in for the first time.</p>

<p>The technical profile <code class="language-plaintext highlighter-rouge">SelfAsserted-Social</code> is as follows:</p>
<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;TechnicalProfile</span> <span class="na">Id=</span><span class="s">"SelfAsserted-Social"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;DisplayName&gt;</span>User ID signup<span class="nt">&lt;/DisplayName&gt;</span>
  <span class="nt">&lt;Protocol</span> <span class="na">Name=</span><span class="s">"Proprietary"</span> <span class="na">Handler=</span><span class="s">"Web.TPEngine.Providers.SelfAssertedAttributeProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;Metadata&gt;</span>
    <span class="nt">&lt;Item</span> <span class="na">Key=</span><span class="s">"ContentDefinitionReferenceId"</span><span class="nt">&gt;</span>api.selfasserted<span class="nt">&lt;/Item&gt;</span>
  <span class="nt">&lt;/Metadata&gt;</span>
  <span class="nt">&lt;CryptographicKeys&gt;</span>
    <span class="nt">&lt;Key</span> <span class="na">Id=</span><span class="s">"issuer_secret"</span> <span class="na">StorageReferenceId=</span><span class="s">"B2C_1A_TokenSigningKeyContainer"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/CryptographicKeys&gt;</span>
  <span class="nt">&lt;InputClaims&gt;</span>
    <span class="nt">&lt;InputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"displayName"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;InputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"givenName"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;InputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"surname"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/InputClaims&gt;</span>
  <span class="nt">&lt;OutputClaims&gt;</span>
    <span class="nt">&lt;OutputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"objectId"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;OutputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"newUser"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;OutputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"executed-SelfAsserted-Input"</span> <span class="na">DefaultValue=</span><span class="s">"true"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;OutputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"displayName"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;OutputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"givenName"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;OutputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"surname"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/OutputClaims&gt;</span>
  <span class="nt">&lt;ValidationTechnicalProfiles&gt;</span>
    <span class="nt">&lt;ValidationTechnicalProfile</span> <span class="na">ReferenceId=</span><span class="s">"AAD-UserWriteUsingAlternativeSecurityId"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/ValidationTechnicalProfiles&gt;</span>
  <span class="nt">&lt;UseTechnicalProfileForSessionManagement</span> <span class="na">ReferenceId=</span><span class="s">"SM-SocialSignup"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/TechnicalProfile&gt;</span>
</code></pre></div></div>

<table>
  <thead>
    <tr>
      <th>Element name</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>TechnicalProfile Id</td>
      <td>Identifier for this technical profile. It is used to find the technical profile that is referenced elsewhere.</td>
    </tr>
    <tr>
      <td>Metadata</td>
      <td>Provides information about the content definition to reference - which will give the page a customised look and feel.</td>
    </tr>
    <tr>
      <td>InputClaims</td>
      <td>These claims ensure that any values retrieved in the previous steps, in this case Facebook authentication, are prefilled. Note that some of these claims may not have any value, for example, if Facebook did not provide any of these values, or if the claim did not appear in the OutputClaims section of the <code class="language-plaintext highlighter-rouge">Facebook-OAUTH</code> technical profile. In addition, if a claim is not in the InputClaims section, but it is in the OutputClaims section, then its value will not be prefilled, but the user will still be prompted for it (with an empty value).</td>
    </tr>
    <tr>
      <td>OutputClaims</td>
      <td>These are claims that will be presented to the user on the rendered page, potentially prefilled based on the inputClaims status. Those claims which cannot be fulfilled by the user, such as objectId and newUser, are not shown on the screen as they are fulfilled by the validation technical profile being referenced.</td>
    </tr>
    <tr>
      <td>ValidationTechnicalProfile</td>
      <td>A validation technical profile is used to write the user account when the user submits the page confirming their information.</td>
    </tr>
  </tbody>
</table>

<p>When the user submits the page, the Validation technical profile will run, called <code class="language-plaintext highlighter-rouge">AAD-UserWriteUsingAlternativeSecurityId</code>. This is called since either the user account can be written successfully based on the information provided, or it cannot be. In this case, the user account should always get written successfully. However, this fits best as a validation technical profile in this case.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nt">&lt;ValidationTechnicalProfile</span> <span class="na">ReferenceId=</span><span class="s">"AAD-UserWriteUsingAlternativeSecurityId"</span> <span class="nt">/&gt;</span>
</code></pre></div></div>

<p>This technical profile appears as follows:</p>
<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;TechnicalProfile</span> <span class="na">Id=</span><span class="s">"AAD-UserWriteUsingAlternativeSecurityId"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;Metadata&gt;</span>
    <span class="nt">&lt;Item</span> <span class="na">Key=</span><span class="s">"Operation"</span><span class="nt">&gt;</span>Write<span class="nt">&lt;/Item&gt;</span>
    <span class="nt">&lt;Item</span> <span class="na">Key=</span><span class="s">"RaiseErrorIfClaimsPrincipalAlreadyExists"</span><span class="nt">&gt;</span>true<span class="nt">&lt;/Item&gt;</span>
    <span class="nt">&lt;Item</span> <span class="na">Key=</span><span class="s">"UserMessageIfClaimsPrincipalAlreadyExists"</span><span class="nt">&gt;</span>You are already registered, please press the back button and sign in instead.<span class="nt">&lt;/Item&gt;</span>
  <span class="nt">&lt;/Metadata&gt;</span>
  <span class="nt">&lt;IncludeInSso&gt;</span>false<span class="nt">&lt;/IncludeInSso&gt;</span>
  <span class="nt">&lt;InputClaimsTransformations&gt;</span>
    <span class="nt">&lt;InputClaimsTransformation</span> <span class="na">ReferenceId=</span><span class="s">"CreateOtherMailsFromEmail"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/InputClaimsTransformations&gt;</span>
  <span class="nt">&lt;InputClaims&gt;</span>
    <span class="nt">&lt;InputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"AlternativeSecurityId"</span> <span class="na">PartnerClaimType=</span><span class="s">"alternativeSecurityId"</span> <span class="na">Required=</span><span class="s">"true"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/InputClaims&gt;</span>
  <span class="nt">&lt;PersistedClaims&gt;</span>
    <span class="c">&lt;!-- Required claims --&gt;</span>
    <span class="nt">&lt;PersistedClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"alternativeSecurityId"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;PersistedClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"userPrincipalName"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;PersistedClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"mailNickName"</span> <span class="na">DefaultValue=</span><span class="s">"unknown"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;PersistedClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"displayName"</span> <span class="na">DefaultValue=</span><span class="s">"unknown"</span> <span class="nt">/&gt;</span>

    <span class="c">&lt;!-- Optional claims --&gt;</span>
    <span class="nt">&lt;PersistedClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"otherMails"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;PersistedClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"givenName"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;PersistedClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"surname"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/PersistedClaims&gt;</span>
  <span class="nt">&lt;OutputClaims&gt;</span>
    <span class="nt">&lt;OutputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"objectId"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;OutputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"newUser"</span> <span class="na">PartnerClaimType=</span><span class="s">"newClaimsPrincipalCreated"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;OutputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"otherMails"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/OutputClaims&gt;</span>
  <span class="nt">&lt;IncludeTechnicalProfile</span> <span class="na">ReferenceId=</span><span class="s">"AAD-Common"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;UseTechnicalProfileForSessionManagement</span> <span class="na">ReferenceId=</span><span class="s">"SM-AAD"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/TechnicalProfile&gt;</span>
</code></pre></div></div>

<table>
  <thead>
    <tr>
      <th>Element name</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>TechnicalProfile Id</td>
      <td>Identifier for this technical profile. It is used to find the technical profile that is referenced elsewhere.</td>
    </tr>
    <tr>
      <td>Metadata</td>
      <td>This is configured to write to the directory. And to throw an error if the user already exists with an error message.</td>
    </tr>
    <tr>
      <td>InputClaimsTransformations</td>
      <td><!-- is this needed? --></td>
    </tr>
    <tr>
      <td>InputClaims</td>
      <td>This is attempting to find a user account with the <code class="language-plaintext highlighter-rouge">alternativeSecurityId</code> generated in the claims transform after the Facebook sign in completed.</td>
    </tr>
    <tr>
      <td>PersistedClaims</td>
      <td>This section defines which claims are to be written when writing to an account.</td>
    </tr>
    <tr>
      <td>OutputClaims</td>
      <td>We are asking to read these claims from account which was just written. The Azure AD B2C claims referenced here have the same name as the attribute name in the directory.</td>
    </tr>
    <tr>
      <td>IncludeTechnicalProfile</td>
      <td>AAD-Common is included to provide the foundational functionality to read or write to the directory.</td>
    </tr>
  </tbody>
</table>

<p><strong>Orchestration Step 5</strong> - Read any additional data from the user object if it is a Local Account.</p>

<p>We maybe storing additional data the user provided or other data on the Local Account user object which allows your application/service to function correctly.</p>

<p>Therefore, we will read the user object for any desired attributes to add into the Azure AD B2C claims bag.</p>

<p>The following Orchestration step calls a technical profile called <code class="language-plaintext highlighter-rouge">AAD-UserReadUsingObjectId</code> which provides this functionality.
The ClaimsExchange Id is unique name for this claims exchange that you can set.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;OrchestrationStep</span> <span class="na">Order=</span><span class="s">"5"</span> <span class="na">Type=</span><span class="s">"ClaimsExchange"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;Preconditions&gt;</span>
    <span class="nt">&lt;Precondition</span> <span class="na">Type=</span><span class="s">"ClaimEquals"</span> <span class="na">ExecuteActionsIf=</span><span class="s">"true"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;Value&gt;</span>authenticationSource<span class="nt">&lt;/Value&gt;</span>
      <span class="nt">&lt;Value&gt;</span>socialIdpAuthentication<span class="nt">&lt;/Value&gt;</span>
      <span class="nt">&lt;Action&gt;</span>SkipThisOrchestrationStep<span class="nt">&lt;/Action&gt;</span>
    <span class="nt">&lt;/Precondition&gt;</span>
  <span class="nt">&lt;/Preconditions&gt;</span>
  <span class="nt">&lt;ClaimsExchanges&gt;</span>
    <span class="nt">&lt;ClaimsExchange</span> <span class="na">Id=</span><span class="s">"AADUserReadWithObjectId"</span> <span class="na">TechnicalProfileReferenceId=</span><span class="s">"AAD-UserReadUsingObjectId"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/ClaimsExchanges&gt;</span>
<span class="nt">&lt;/OrchestrationStep&gt;</span>
</code></pre></div></div>

<p>A <strong>precondition</strong> is used such that this step is skipped if the value of <code class="language-plaintext highlighter-rouge">authenticationSource</code> is set to <code class="language-plaintext highlighter-rouge">socialIdpAuthentication</code>. This prevents it being run for Social Accounts, and only runs in the case of a Local Account logon.</p>

<p>The referenced technical profile is as follows:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;TechnicalProfile</span> <span class="na">Id=</span><span class="s">"AAD-UserReadUsingObjectId"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;Metadata&gt;</span>
    <span class="nt">&lt;Item</span> <span class="na">Key=</span><span class="s">"Operation"</span><span class="nt">&gt;</span>Read<span class="nt">&lt;/Item&gt;</span>
    <span class="nt">&lt;Item</span> <span class="na">Key=</span><span class="s">"RaiseErrorIfClaimsPrincipalDoesNotExist"</span><span class="nt">&gt;</span>true<span class="nt">&lt;/Item&gt;</span>
  <span class="nt">&lt;/Metadata&gt;</span>
  <span class="nt">&lt;IncludeInSso&gt;</span>false<span class="nt">&lt;/IncludeInSso&gt;</span>
  <span class="nt">&lt;InputClaims&gt;</span>
    <span class="nt">&lt;InputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"objectId"</span> <span class="na">Required=</span><span class="s">"true"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/InputClaims&gt;</span>
  <span class="nt">&lt;OutputClaims&gt;</span>
    <span class="nt">&lt;OutputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"signInNames.emailAddress"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;OutputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"displayName"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;OutputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"otherMails"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;OutputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"givenName"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;OutputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"surname"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/OutputClaims&gt;</span>
  <span class="nt">&lt;IncludeTechnicalProfile</span> <span class="na">ReferenceId=</span><span class="s">"AAD-Common"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/TechnicalProfile&gt;</span>
</code></pre></div></div>

<p>This technical profile does not state a protocol, therefore is automatically of type Azure Active Directory, which provides the ability to read or write to the directory structure.</p>

<table>
  <thead>
    <tr>
      <th>Element name</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>TechnicalProfile Id</td>
      <td>Identifier for this technical profile. It is used to find the technical profile that this orchestration step calls.</td>
    </tr>
    <tr>
      <td>Metadata</td>
      <td>This is configured to read the directory. And to throw an error if the user is not found.</td>
    </tr>
    <tr>
      <td>InputClaims</td>
      <td>This is asking to find a user account with the objectId in the Azure AD B2C claims bag. This objectId will have been received via the login-NonInteractive technical profile and output into the claims bag by the SelfAsserted-LocalAccountSignin-Email technical profile.</td>
    </tr>
    <tr>
      <td>OutputClaims</td>
      <td>We are asking to read these claims from the directory. The Azure AD B2C claims referenced here have the same name as the attribute name in the directory.</td>
    </tr>
    <tr>
      <td>IncludeTechnicalProfile</td>
      <td>AAD-Common is included to provide the foundational functionality to read or write to the directory.</td>
    </tr>
  </tbody>
</table>

<p>A special case must be noted for the <code class="language-plaintext highlighter-rouge">signInNames.emailAddress</code>, this references the attribute <code class="language-plaintext highlighter-rouge">signInNames</code> which is a collection of key value pairs. In this case we are reading back the <code class="language-plaintext highlighter-rouge">emailAddress</code> key within the <code class="language-plaintext highlighter-rouge">signInNames</code> attribute.</p>

<p><strong>Orchestration Step 6</strong>: In the case that the Orchestration step 4 was removed, there is a backup option here to write the Social Account into the directory at this point in the journey. In such a case, the objectId would not yet exist in the Azure AD B2C claims bag, therefore a <strong>precondition</strong> is used such that this step is executed if one is still not present.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;OrchestrationStep</span> <span class="na">Order=</span><span class="s">"6"</span> <span class="na">Type=</span><span class="s">"ClaimsExchange"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;Preconditions&gt;</span>
    <span class="nt">&lt;Precondition</span> <span class="na">Type=</span><span class="s">"ClaimsExist"</span> <span class="na">ExecuteActionsIf=</span><span class="s">"true"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;Value&gt;</span>objectId<span class="nt">&lt;/Value&gt;</span>
      <span class="nt">&lt;Action&gt;</span>SkipThisOrchestrationStep<span class="nt">&lt;/Action&gt;</span>
    <span class="nt">&lt;/Precondition&gt;</span>
  <span class="nt">&lt;/Preconditions&gt;</span>
  <span class="nt">&lt;ClaimsExchanges&gt;</span>
    <span class="nt">&lt;ClaimsExchange</span> <span class="na">Id=</span><span class="s">"AADUserWrite"</span> <span class="na">TechnicalProfileReferenceId=</span><span class="s">"AAD-UserWriteUsingAlternativeSecurityId"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/ClaimsExchanges&gt;</span>
<span class="nt">&lt;/OrchestrationStep&gt;</span>
</code></pre></div></div>

<p>The functionality of the <code class="language-plaintext highlighter-rouge">AAD-UserWriteUsingAlternativeSecurityId</code> has already been explored earlier.</p>

<p><strong>Orchestration Step 7</strong>:- Issue an id token.</p>

<p>In the majority of user journeys, the journey will end by issuing an id token back to the application. This orchestration step looks as follows:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;OrchestrationStep</span> <span class="na">Order=</span><span class="s">"7"</span> <span class="na">Type=</span><span class="s">"SendClaims"</span> <span class="na">CpimIssuerTechnicalProfileReferenceId=</span><span class="s">"JwtIssuer"</span> <span class="nt">/&gt;</span>
</code></pre></div></div>

<p>The referenced technical profile is as follows:</p>
<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;TechnicalProfile</span> <span class="na">Id=</span><span class="s">"JwtIssuer"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;DisplayName&gt;</span>JWT Issuer<span class="nt">&lt;/DisplayName&gt;</span>
  <span class="nt">&lt;Protocol</span> <span class="na">Name=</span><span class="s">"None"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;OutputTokenFormat&gt;</span>JWT<span class="nt">&lt;/OutputTokenFormat&gt;</span>
  <span class="nt">&lt;Metadata&gt;</span>
    <span class="nt">&lt;Item</span> <span class="na">Key=</span><span class="s">"client_id"</span><span class="nt">&gt;</span>{service:te}<span class="nt">&lt;/Item&gt;</span>
    <span class="nt">&lt;Item</span> <span class="na">Key=</span><span class="s">"issuer_refresh_token_user_identity_claim_type"</span><span class="nt">&gt;</span>objectId<span class="nt">&lt;/Item&gt;</span>
    <span class="nt">&lt;Item</span> <span class="na">Key=</span><span class="s">"SendTokenResponseBodyWithJsonNumbers"</span><span class="nt">&gt;</span>true<span class="nt">&lt;/Item&gt;</span>
  <span class="nt">&lt;/Metadata&gt;</span>
  <span class="nt">&lt;CryptographicKeys&gt;</span>
    <span class="nt">&lt;Key</span> <span class="na">Id=</span><span class="s">"issuer_secret"</span> <span class="na">StorageReferenceId=</span><span class="s">"B2C_1A_TokenSigningKeyContainer"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;Key</span> <span class="na">Id=</span><span class="s">"issuer_refresh_token_key"</span> <span class="na">StorageReferenceId=</span><span class="s">"B2C_1A_TokenEncryptionKeyContainer"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/CryptographicKeys&gt;</span>
  <span class="nt">&lt;InputClaims</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;OutputClaims</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/TechnicalProfile&gt;</span>
</code></pre></div></div>

<p>This step does not need configuring any further, but find out more <a href="https://docs.microsoft.com/en-us/azure/active-directory-b2c/jwt-issuer-technical-profile">here</a> on available options.</p>

<h3 id="handling-local-account-sign-up">Handling Local Account Sign Up:</h3>
<p>To handle sign up, we must have one additional orchestration step which allows the user to provide their email, new password and name. And upon validating this information, we must write an account to the directory. the other steps are shared with the orchestration steps explained in <code class="language-plaintext highlighter-rouge">Handling Sign in</code>.</p>

<p>The additional orchestration step is as follows:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;OrchestrationStep</span> <span class="na">Order=</span><span class="s">"2"</span> <span class="na">Type=</span><span class="s">"ClaimsExchange"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;Preconditions&gt;</span>
    <span class="nt">&lt;Precondition</span> <span class="na">Type=</span><span class="s">"ClaimsExist"</span> <span class="na">ExecuteActionsIf=</span><span class="s">"true"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;Value&gt;</span>objectId<span class="nt">&lt;/Value&gt;</span>
      <span class="nt">&lt;Action&gt;</span>SkipThisOrchestrationStep<span class="nt">&lt;/Action&gt;</span>
    <span class="nt">&lt;/Precondition&gt;</span>
  <span class="nt">&lt;/Preconditions&gt;</span>
  <span class="nt">&lt;ClaimsExchanges&gt;</span>
    <span class="nt">&lt;ClaimsExchange</span> <span class="na">Id=</span><span class="s">"SignUpWithLogonEmailExchange"</span> <span class="na">TechnicalProfileReferenceId=</span><span class="s">"LocalAccountSignUpWithLogonEmail"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/ClaimsExchanges&gt;</span>
<span class="nt">&lt;/OrchestrationStep&gt;</span>
</code></pre></div></div>

<p>Since orchestration steps run sequentially, we must not run this step if the user is trying to sign in, and only run if the user clicked the sign up link. This is achieved using the <strong>Precondition</strong>. Note, that during the sign in phase, the Azure AD B2C claims bag will have an objectId populated after <code class="language-plaintext highlighter-rouge">login-NonInteractive</code> has run. Therefore we can use the existence of this claim to skip this step as follows.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;Precondition</span> <span class="na">Type=</span><span class="s">"ClaimsExist"</span> <span class="na">ExecuteActionsIf=</span><span class="s">"true"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;Value&gt;</span>objectId<span class="nt">&lt;/Value&gt;</span>
    <span class="nt">&lt;Action&gt;</span>SkipThisOrchestrationStep<span class="nt">&lt;/Action&gt;</span>
<span class="nt">&lt;/Precondition&gt;</span>
</code></pre></div></div>

<p>When displaying the Combined Sign in and Sign up page, it was mentioned that the metadata of the <code class="language-plaintext highlighter-rouge">SelfAsserted-LocalAccountSignin-Email</code> technical profile configures an item called <code class="language-plaintext highlighter-rouge">SignUpTarget</code>. This enables the Sign Up link on the Combined Sign in and Sign up page to call the claims exchange in orchestration Step 2, which consequently executes the <code class="language-plaintext highlighter-rouge">LocalAccountSignUpWithLogonEmail</code> technical profile.</p>

<p>The technical profile is designed to capture the email, password and name of the user, and then write the account to the directory, as follows:</p>
<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;TechnicalProfile</span> <span class="na">Id=</span><span class="s">"LocalAccountSignUpWithLogonEmail"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;DisplayName&gt;</span>Email signup<span class="nt">&lt;/DisplayName&gt;</span>
  <span class="nt">&lt;Protocol</span> <span class="na">Name=</span><span class="s">"Proprietary"</span> <span class="na">Handler=</span><span class="s">"Web.TPEngine.Providers.SelfAssertedAttributeProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;Metadata&gt;</span>
    <span class="nt">&lt;Item</span> <span class="na">Key=</span><span class="s">"IpAddressClaimReferenceId"</span><span class="nt">&gt;</span>IpAddress<span class="nt">&lt;/Item&gt;</span>
    <span class="nt">&lt;Item</span> <span class="na">Key=</span><span class="s">"ContentDefinitionReferenceId"</span><span class="nt">&gt;</span>api.localaccountsignup<span class="nt">&lt;/Item&gt;</span>
    <span class="nt">&lt;Item</span> <span class="na">Key=</span><span class="s">"language.button_continue"</span><span class="nt">&gt;</span>Create<span class="nt">&lt;/Item&gt;</span>
  <span class="nt">&lt;/Metadata&gt;</span>
  <span class="nt">&lt;CryptographicKeys&gt;</span>
    <span class="nt">&lt;Key</span> <span class="na">Id=</span><span class="s">"issuer_secret"</span> <span class="na">StorageReferenceId=</span><span class="s">"B2C_1A_TokenSigningKeyContainer"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/CryptographicKeys&gt;</span>
  <span class="nt">&lt;InputClaims&gt;</span>
    <span class="nt">&lt;InputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"email"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/InputClaims&gt;</span>
  <span class="nt">&lt;OutputClaims&gt;</span>
    <span class="nt">&lt;OutputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"objectId"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;OutputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"email"</span> <span class="na">PartnerClaimType=</span><span class="s">"Verified.Email"</span> <span class="na">Required=</span><span class="s">"true"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;OutputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"newPassword"</span> <span class="na">Required=</span><span class="s">"true"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;OutputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"reenterPassword"</span> <span class="na">Required=</span><span class="s">"true"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;OutputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"executed-SelfAsserted-Input"</span> <span class="na">DefaultValue=</span><span class="s">"true"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;OutputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"authenticationSource"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;OutputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"newUser"</span> <span class="nt">/&gt;</span>

    <span class="c">&lt;!-- Optional claims, to be collected from the user --&gt;</span>
    <span class="nt">&lt;OutputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"displayName"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;OutputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"givenName"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;OutputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"surName"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/OutputClaims&gt;</span>
  <span class="nt">&lt;ValidationTechnicalProfiles&gt;</span>
    <span class="nt">&lt;ValidationTechnicalProfile</span> <span class="na">ReferenceId=</span><span class="s">"AAD-UserWriteUsingLogonEmail"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/ValidationTechnicalProfiles&gt;</span>
  <span class="nt">&lt;UseTechnicalProfileForSessionManagement</span> <span class="na">ReferenceId=</span><span class="s">"SM-AAD"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/TechnicalProfile&gt;</span>

</code></pre></div></div>

<table>
  <thead>
    <tr>
      <th>Element name</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>TechnicalProfile Id</td>
      <td>Identifier for this technical profile. It is used to find the technical profile that is referenced elsewhere.</td>
    </tr>
    <tr>
      <td>Metadata</td>
      <td>This is configured with a reference to a content definition to provide your custom look and feel to this page.</td>
    </tr>
    <tr>
      <td>InputClaims</td>
      <td>This will pre-popualte the email field if the email claim was acquired earlier in the journey.</td>
    </tr>
    <tr>
      <td>OutputClaims</td>
      <td>These are claims that will be presented to the user on the rendered page, potentially prefilled based on the inputClaims status. Those claims which cannot be fulfilled by the user, such as objectId and newUser, are not shown on the screen as they are fulfilled by the validation technical profile being referenced.</td>
    </tr>
    <tr>
      <td>ValidationTechnicalProfile</td>
      <td>A validation technical profile is used to write the user account when the user submits the page confirming their information.</td>
    </tr>
  </tbody>
</table>

<p>To see all the configuration options for a Self-Asserted technical profile, find more <a href="https://docs.microsoft.com/en-us/azure/active-directory-b2c/self-asserted-technical-profile">here</a>.</p>

<p>Azure AD B2C uses a special partner claim type to enforce email verification on a claim, as seen here:</p>
<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;OutputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"email"</span> <span class="na">PartnerClaimType=</span><span class="s">"Verified.Email"</span> <span class="na">Required=</span><span class="s">"true"</span> <span class="nt">/&gt;</span>
</code></pre></div></div>
<p>Here we are forcing the email claim presented on screen to be verified. Azure AD B2C will therefore render the <code class="language-plaintext highlighter-rouge">Verify</code> button on the page against this text field, and only allow the user to continue if this field was verified by a code sent to the users inbox. This technique can be used against any claim name presented to the user as an output claim (ClaimTypeReferenceId).</p>

<p>When the user submits the page, the Validation technical profile will run, called <code class="language-plaintext highlighter-rouge">AAD-UserWriteUsingLogonEmail</code>. This is called since either the user account can be written successfully based on the information provided, or it cannot be. In this case, the user account may not be able to be written if the account exists.</p>

<p>The <code class="language-plaintext highlighter-rouge">AAD-UserWriteUsingLogonEmail</code> is as follows:</p>
<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;TechnicalProfile</span> <span class="na">Id=</span><span class="s">"AAD-UserWriteUsingLogonEmail"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;Metadata&gt;</span>
    <span class="nt">&lt;Item</span> <span class="na">Key=</span><span class="s">"Operation"</span><span class="nt">&gt;</span>Write<span class="nt">&lt;/Item&gt;</span>
    <span class="nt">&lt;Item</span> <span class="na">Key=</span><span class="s">"RaiseErrorIfClaimsPrincipalAlreadyExists"</span><span class="nt">&gt;</span>true<span class="nt">&lt;/Item&gt;</span>
  <span class="nt">&lt;/Metadata&gt;</span>
  <span class="nt">&lt;IncludeInSso&gt;</span>false<span class="nt">&lt;/IncludeInSso&gt;</span>
  <span class="nt">&lt;InputClaims&gt;</span>
    <span class="nt">&lt;InputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"email"</span> <span class="na">PartnerClaimType=</span><span class="s">"signInNames.emailAddress"</span> <span class="na">Required=</span><span class="s">"true"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/InputClaims&gt;</span>
  <span class="nt">&lt;PersistedClaims&gt;</span>
    <span class="c">&lt;!-- Required claims --&gt;</span>
    <span class="nt">&lt;PersistedClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"email"</span> <span class="na">PartnerClaimType=</span><span class="s">"signInNames.emailAddress"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;PersistedClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"newPassword"</span> <span class="na">PartnerClaimType=</span><span class="s">"password"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;PersistedClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"displayName"</span> <span class="na">DefaultValue=</span><span class="s">"unknown"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;PersistedClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"passwordPolicies"</span> <span class="na">DefaultValue=</span><span class="s">"DisablePasswordExpiration"</span> <span class="nt">/&gt;</span>

    <span class="c">&lt;!-- Optional claims. --&gt;</span>
    <span class="nt">&lt;PersistedClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"givenName"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;PersistedClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"surname"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/PersistedClaims&gt;</span>
  <span class="nt">&lt;OutputClaims&gt;</span>
    <span class="nt">&lt;OutputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"objectId"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;OutputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"newUser"</span> <span class="na">PartnerClaimType=</span><span class="s">"newClaimsPrincipalCreated"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;OutputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"authenticationSource"</span> <span class="na">DefaultValue=</span><span class="s">"localAccountAuthentication"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;OutputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"userPrincipalName"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;OutputClaim</span> <span class="na">ClaimTypeReferenceId=</span><span class="s">"signInNames.emailAddress"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/OutputClaims&gt;</span>
  <span class="nt">&lt;IncludeTechnicalProfile</span> <span class="na">ReferenceId=</span><span class="s">"AAD-Common"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;UseTechnicalProfileForSessionManagement</span> <span class="na">ReferenceId=</span><span class="s">"SM-AAD"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/TechnicalProfile&gt;</span>
</code></pre></div></div>

<table>
  <thead>
    <tr>
      <th>Element name</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>TechnicalProfile Id</td>
      <td>Identifier for this technical profile. It is used to find the technical profile that is referenced elsewhere.</td>
    </tr>
    <tr>
      <td>Metadata</td>
      <td>This is configured to write to the directory. And to throw an error if the user already exists with an error message.</td>
    </tr>
    <tr>
      <td>InputClaims</td>
      <td>This is attempting to find a user account with the <code class="language-plaintext highlighter-rouge">email</code> provided as part of the sign up page - <code class="language-plaintext highlighter-rouge">LocalAccountSignUpWithLogonEmail</code> technical profile.</td>
    </tr>
    <tr>
      <td>PersistedClaims</td>
      <td>This section defines which claims are to be written to the account. In this case, it will automatically create the account with this information present.</td>
    </tr>
    <tr>
      <td>OutputClaims</td>
      <td>We are asking to read these claims from account which was just written. The Azure AD B2C claims referenced here have the same name as the attribute name in the directory.</td>
    </tr>
    <tr>
      <td>IncludeTechnicalProfile</td>
      <td>AAD-Common is included to provide the foundational functionality to read or write to the directory.</td>
    </tr>
  </tbody>
</table>

<p>*Orchestration Step 7**:- Issue an id token.</p>

<p>In the majority of user journeys, the journey will end by issuing an id token back to the application. This orchestration step looks as follows:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;OrchestrationStep</span> <span class="na">Order=</span><span class="s">"7"</span> <span class="na">Type=</span><span class="s">"SendClaims"</span> <span class="na">CpimIssuerTechnicalProfileReferenceId=</span><span class="s">"JwtIssuer"</span> <span class="nt">/&gt;</span>
</code></pre></div></div>

<p>The referenced technical profile is as follows:</p>
<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;TechnicalProfile</span> <span class="na">Id=</span><span class="s">"JwtIssuer"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;DisplayName&gt;</span>JWT Issuer<span class="nt">&lt;/DisplayName&gt;</span>
  <span class="nt">&lt;Protocol</span> <span class="na">Name=</span><span class="s">"None"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;OutputTokenFormat&gt;</span>JWT<span class="nt">&lt;/OutputTokenFormat&gt;</span>
  <span class="nt">&lt;Metadata&gt;</span>
    <span class="nt">&lt;Item</span> <span class="na">Key=</span><span class="s">"client_id"</span><span class="nt">&gt;</span>{service:te}<span class="nt">&lt;/Item&gt;</span>
    <span class="nt">&lt;Item</span> <span class="na">Key=</span><span class="s">"issuer_refresh_token_user_identity_claim_type"</span><span class="nt">&gt;</span>objectId<span class="nt">&lt;/Item&gt;</span>
    <span class="nt">&lt;Item</span> <span class="na">Key=</span><span class="s">"SendTokenResponseBodyWithJsonNumbers"</span><span class="nt">&gt;</span>true<span class="nt">&lt;/Item&gt;</span>
  <span class="nt">&lt;/Metadata&gt;</span>
  <span class="nt">&lt;CryptographicKeys&gt;</span>
    <span class="nt">&lt;Key</span> <span class="na">Id=</span><span class="s">"issuer_secret"</span> <span class="na">StorageReferenceId=</span><span class="s">"B2C_1A_TokenSigningKeyContainer"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;Key</span> <span class="na">Id=</span><span class="s">"issuer_refresh_token_key"</span> <span class="na">StorageReferenceId=</span><span class="s">"B2C_1A_TokenEncryptionKeyContainer"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/CryptographicKeys&gt;</span>
  <span class="nt">&lt;InputClaims</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;OutputClaims</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/TechnicalProfile&gt;</span>
</code></pre></div></div>

<p>This step does not need configuring any further, but find out more <a href="https://docs.microsoft.com/en-us/azure/active-directory-b2c/jwt-issuer-technical-profile">here</a> on available options.</p>

<h2 id="summary">Summary</h2>
<p>By reducing the user experience to a set of logical steps, we have translated these to a set of Orchestration Steps within an Azure AD B2C policy. These orchestration steps then implement the functionality of each logical step by allowing the user to interact with pages and validate various information. Finally we issue an id token back to the application.</p>

      <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <div align="center" style="margin: 1em 0;">
        <ins class="adsbygoogle"
             style="display:block; border-bottom: initial;"
             data-ad-client="ca-pub-7328585512091257"
             data-ad-slot="3049671934"
             data-ad-format="auto"></ins>
        </div>
        <script>
        (adsbygoogle = window.adsbygoogle || []).push({});
      </script>
    </div>

    

    <div class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    
      
        
          <li><a href="https://stackoverflow.com/questions/tagged/azure-ad-b2c" rel="nofollow noopener noreferrer"><i class="fab fa-stack-overflow" aria-hidden="true"></i> Stackoverflow</a></li>
        
      
        
          <li><a href="https://github.com/azure-ad-b2c" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
        
          <li><a href="https://woodgrovegroceriesb2cdemo.azurewebsites.net/" rel="nofollow noopener noreferrer"><i class="fas fa-laptop" aria-hidden="true"></i> Demo Site</a></li>
        
      
        
          <li><a href="https://azure.microsoft.com/en-us/services/active-directory-b2c/" rel="nofollow noopener noreferrer"><i class="fab fa-microsoft" aria-hidden="true"></i> Offical docs</a></li>
        
      
        
          <li><a href="https://www.youtube.com/results?search_query=azure+ad+b2c" rel="nofollow noopener noreferrer"><i class="fab fa-youtube" aria-hidden="true"></i> YouTube</a></li>
        
      
    

    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2020 Michael Rose. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script src="https://kit.fontawesome.com/4eee35f757.js"></script>










  </body>
</html>